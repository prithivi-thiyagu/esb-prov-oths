# Step 1: Build the Spring Boot application using Maven
FROM maven:3.8.4-eclipse-temurin-17 AS builder

# Copy the single dependency from the build context into the container
COPY esb-common-util-1.0.0.jar /tmp/
COPY esb-common-util-1.0.0-exec.jar /tmp/


RUN mvn install:install-file -Dfile=/tmp/esb-common-util-1.0.0.jar -DgroupId=com.bandhanbank -DartifactId=esb-common-util -Dversion=1.0.0 -Dpackaging=jar  -Dmaven.repo.local=/root/.m2/repository -DproxySet=true -DproxyHost=10.1.64.13 -DproxyPort=8080

#RUN mvn install:install-file -Dfile=/tmp/esb-common-util-1.0.0-exec.jar -DgroupId=com.bandhanbank -DartifactId=esb-common-util -Dversion=1.0.0 -Dpackaging=jar  -Dmaven.repo.local=/root/.m2/repository -DproxySet=true -DproxyHost=10.1.64.13 -DproxyPort=8080

RUN ls -ltr /root/.m2/repository/com/bandhanbank/esb-common-util/1.0.0/

#RUN mvn install:install-file -Dfile=/tmp/esb-common-util-1.0.0.jar -DgroupId=com.bandhanbank -DartifactId=esb-common-util -Dversion=1.0.0 -Dpackaging=jar  -Dmaven.repo.local=/root/.m2/repository -DproxySet=true -DproxyHost=10.1.64.13 -DproxyPort=8080
#RUN ls -ltr /root/.m2/repository/com/bandhanbank/esb-common-util/1.0.0/

# Copy application code 
COPY . /app

# Set the working directory
WORKDIR /app
 
# Copy Maven dependencies and source code
COPY pom.xml /app

# RUN mvn dependency:go-offline
COPY src /app/src

RUN ls -ltr /app/target

# Build the application
RUN mvn clean install -P local-auth-util -DskipTests=true -Dmaven.repo.local=/root/.m2/repository -DproxySet=true -DproxyHost=10.1.64.13 -DproxyPort=8080 

RUN ls -ltr /app/target && du -sh /app/target/*

#Step 2: Use a base image with Java and a minimal Linux distribution
FROM eclipse-temurin:17-jre-alpine

# Set the working directory inside the container
WORKDIR /app

# Expose the port your Spring Boot app is running on (default is 8080)

EXPOSE 8080

RUN mkdir /extract
COPY --from=builder /app/target/* /extract/

# Copy the JAR file into the container
COPY --from=builder /app/target/*.jar app.jar

# Define the command to run your Spring Boot application
CMD ["java", "-jar", "app.jar"]
